# M-B0078-001 API ä¸²æ¥èªªæ˜

## ğŸ“Š èˆ‡å…¶ä»– API çš„æ ¸å¿ƒå·®ç•°

### 1. API é¡å‹å°æ¯”

#### M-B0078-001 (fileapi)
```
https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/M-B0078-001
```
- **è³‡æ–™æ€§è³ª**: æ•¸å€¼æ¨¡å¼é å ±æª”æ¡ˆ
- **æ›´æ–°æ–¹å¼**: æ•´å€‹æª”æ¡ˆæ›¿æ›ï¼ˆæ¯ 6 å°æ™‚ç™¼å¸ƒæ–°é å ±ï¼‰
- **æª”æ¡ˆå¤§å°**: ~1-5 MB
- **è³‡æ–™ç­†æ•¸**: 119 å€‹åœ°é» Ã— 23 å€‹æ™‚é–“é» = 2,737 ç­†è³‡æ–™

#### O-B0075-001 (datastore)  
```
https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-B0075-001
```
- **è³‡æ–™æ€§è³ª**: å³æ™‚è§€æ¸¬è³‡æ–™
- **æ›´æ–°æ–¹å¼**: æŒçºŒè¿½åŠ æ–°è§€æ¸¬ï¼ˆæ¯å°æ™‚æ›´æ–°ï¼‰
- **æª”æ¡ˆå¤§å°**: ä¾æŸ¥è©¢è€Œå®šï¼ˆå¯ç”¨ StationID éæ¿¾ï¼‰
- **è³‡æ–™ç­†æ•¸**: å–®ä¸€æ¸¬ç«™æœ€è¿‘ 48-72 ç­†è§€æ¸¬

---

## ğŸ”„ è³‡æ–™æ›´æ–°æ©Ÿåˆ¶

### M-B0078-001 çš„æ›´æ–°æ™‚ç¨‹

```
00:00 ç™¼å¸ƒ â†’ é å ± 04:00 ~ å¾Œ 72 å°æ™‚
06:00 ç™¼å¸ƒ â†’ é å ± 10:00 ~ å¾Œ 72 å°æ™‚  â† ç›®å‰é€™å€‹
12:00 ç™¼å¸ƒ â†’ é å ± 16:00 ~ å¾Œ 72 å°æ™‚
18:00 ç™¼å¸ƒ â†’ é å ± 22:00 ~ å¾Œ 72 å°æ™‚
```

**å¯¦éš›è³‡æ–™ç¯„ä¾‹**:
```json
{
  "IssueTime": "2025-12-06T06:00:00+08:00",    // 06:00 ç™¼å¸ƒ
  "StartTime": "2025-12-06T10:00:00+08:00",    // å¾ 10:00 é–‹å§‹
  "EndTime": "2025-12-09T10:00:00+08:00",      // é å ±åˆ° 12/9 10:00
  "location": [
    {
      "DateTime": "2025-12-06T12:00:00+08:00", // ç¬¬ 1 ç­†ï¼šä¸­åˆ 12 é»
      "SignificantWaveHeight": "0.9"
    },
    {
      "DateTime": "2025-12-06T15:00:00+08:00", // ç¬¬ 2 ç­†ï¼šä¸‹åˆ 3 é»
      "SignificantWaveHeight": "0.9"
    },
    // ... æ¯ 3 å°æ™‚ä¸€ç­†ï¼Œå…± 23 ç­†
  ]
}
```

---

## ğŸ¯ ETag å¿«å–æ©Ÿåˆ¶ï¼ˆé‡é»ï¼ï¼‰

### ç‚ºä»€éº¼ M-B0078-001 éœ€è¦ ETagï¼Ÿ

å› ç‚ºæ¯æ¬¡è«‹æ±‚éƒ½æœƒä¸‹è¼‰ **å®Œæ•´çš„ 1-5 MB è³‡æ–™**ï¼Œä½†è³‡æ–™åªæœ‰**æ¯ 6 å°æ™‚æ‰æ›´æ–°ä¸€æ¬¡**ï¼Œå¦‚æœæ¯æ¬¡éƒ½é‡æ–°ä¸‹è¼‰æœƒæµªè²»ï¼š
- âŒ æµé‡ï¼ˆ1 MB Ã— æ¯å°æ™‚æŸ¥è©¢ = 24 MB/å¤©ï¼‰
- âŒ æ™‚é–“ï¼ˆä¸‹è¼‰å»¶é²ï¼‰
- âŒ CWA API é…é¡

### ETag å¦‚ä½•é‹ä½œ

#### ç¬¬ä¸€æ¬¡è«‹æ±‚ï¼ˆå†·å•Ÿå‹•ï¼‰
```http
GET /fileapi/v1/opendataapi/M-B0078-001?Authorization=KEY&format=JSON

Response:
HTTP/1.1 200 OK
ETag: "3d8a75e7265aa67f9b81e4ea230ee327-1"
Content-Length: 1091301

{ "cwaopendata": { ... } }  â† å®Œæ•´ 1.09 MB è³‡æ–™
```

#### å¾ŒçºŒè«‹æ±‚ï¼ˆå¸¶ ETagï¼‰
```http
GET /fileapi/v1/opendataapi/M-B0078-001?Authorization=KEY&format=JSON
If-None-Match: "3d8a75e7265aa67f9b81e4ea230ee327-1"

â— æƒ…æ³ Aï¼šè³‡æ–™æœªè®Šï¼ˆåŒä¸€æ¬¡ç™¼å¸ƒï¼‰
Response:
HTTP/1.1 304 Not Modified
ETag: "3d8a75e7265aa67f9b81e4ea230ee327-1"
Content-Length: 0

(æ²’æœ‰ bodyï¼) â† ç¯€çœ 1 MB æµé‡ï¼

â— æƒ…æ³ Bï¼šè³‡æ–™å·²æ›´æ–°ï¼ˆæ–°ä¸€è¼ªç™¼å¸ƒï¼‰
Response:
HTTP/1.1 200 OK
ETag: "new-etag-12345678"  â† æ–°çš„ ETag
Content-Length: 1095847

{ "cwaopendata": { ... } }  â† æ–°çš„å®Œæ•´è³‡æ–™
```

---

## ğŸ’¾ å¿«å–ç­–ç•¥å»ºè­°

### æ–¹æ¡ˆ 1ï¼šè¨˜æ†¶é«” + ç¡¬ç¢Ÿå¿«å–
```javascript
class WaveForecastCache {
  constructor() {
    this.etag = null;           // ç•¶å‰ ETag
    this.data = null;           // è³‡æ–™å¿«å–ï¼ˆè¨˜æ†¶é«”ï¼‰
    this.lastFetchTime = null;  // æœ€å¾Œæ›´æ–°æ™‚é–“
  }
  
  async fetch() {
    // 1. å¦‚æœè·é›¢ä¸Šæ¬¡æ›´æ–° < 3 å°æ™‚ï¼Œç›´æ¥ç”¨å¿«å–
    if (this.isCacheFresh(3)) {
      return this.data;
    }
    
    // 2. å¦å‰‡ï¼Œç”¨ ETag æŸ¥è©¢
    const headers = this.etag ? { 'If-None-Match': this.etag } : {};
    const response = await axios.get(url, { headers });
    
    if (response.status === 304) {
      // è³‡æ–™æ²’è®Šï¼Œæ›´æ–°æ™‚é–“æˆ³ä½†ç¹¼çºŒç”¨èˆŠè³‡æ–™
      this.lastFetchTime = Date.now();
      return this.data;
    }
    
    // 3. æ–°è³‡æ–™ï¼Œæ›´æ–°å…¨éƒ¨
    this.etag = response.headers['etag'];
    this.data = response.data;
    this.lastFetchTime = Date.now();
    
    // 4. å­˜åˆ°ç¡¬ç¢Ÿï¼ˆserver é‡å•Ÿæ™‚å¯æ¢å¾©ï¼‰
    this.saveToDisk();
    
    return this.data;
  }
}
```

### æ–¹æ¡ˆ 2ï¼šç™¼å¸ƒæ™‚é–“æ™ºèƒ½å¿«å–
```javascript
async function smartFetch() {
  const now = new Date();
  const hour = now.getHours();
  
  // è¨ˆç®—è·é›¢ä¸‹ä¸€æ¬¡ç™¼å¸ƒé‚„æœ‰å¤šä¹…
  const nextIssue = [0, 6, 12, 18].find(h => h > hour) || 24;
  const hoursUntilNext = nextIssue - hour;
  
  if (this.lastFetchTime) {
    const hoursSinceLastFetch = (now - this.lastFetchTime) / (1000 * 60 * 60);
    
    // å¦‚æœä¸Šæ¬¡æ›´æ–°åœ¨ç•¶å‰ç™¼å¸ƒé€±æœŸå…§ï¼Œç›´æ¥ç”¨å¿«å–
    if (hoursSinceLastFetch < hoursUntilNext) {
      console.log(`ä½¿ç”¨å¿«å–ï¼Œä¸‹æ¬¡æ›´æ–°æ™‚é–“ï¼š${nextIssue}:00`);
      return this.data;
    }
  }
  
  // å¦å‰‡é‡æ–°æŸ¥è©¢
  return this.fetchWithETag();
}
```

---

## ğŸ“ˆ æ•ˆèƒ½å°æ¯”

### ä¸ä½¿ç”¨ ETag
```
æ¯å°æ™‚æŸ¥è©¢ä¸€æ¬¡ï¼ˆä¿æŒè³‡æ–™æ–°é®®ï¼‰ï¼š
- æ¯æ¬¡ä¸‹è¼‰ï¼š1-5 MB
- ä¸€å¤©ç¸½æµé‡ï¼š24-120 MB
- API å‘¼å«æ¬¡æ•¸ï¼š24 æ¬¡/å¤©
```

### ä½¿ç”¨ ETag + 3å°æ™‚å¿«å–
```
æ¯ 3 å°æ™‚æŸ¥è©¢ä¸€æ¬¡ï¼š
- ç¬¬ 0 å°æ™‚ï¼š1 MBï¼ˆé¦–æ¬¡ä¸‹è¼‰ï¼‰
- ç¬¬ 3 å°æ™‚ï¼š1 KBï¼ˆ304 å›æ‡‰ï¼‰
- ç¬¬ 6 å°æ™‚ï¼š1 MBï¼ˆæ–°è³‡æ–™ï¼‰
- ç¬¬ 9 å°æ™‚ï¼š1 KBï¼ˆ304ï¼‰
- ...
- ä¸€å¤©ç¸½æµé‡ï¼š~4 MBï¼ˆä¸‹è¼‰ï¼‰ + 32 KBï¼ˆ304 å›æ‡‰ï¼‰
- API å‘¼å«æ¬¡æ•¸ï¼š8 æ¬¡/å¤©
- **ç¯€çœæµé‡ï¼š~95%**
- **ç¯€çœ API é…é¡ï¼š67%**
```

---

## ğŸ”§ å¯¦ä½œå»ºè­°

### 1. å¾Œç«¯ API è¨­è¨ˆ
```javascript
// âŒ ä¸è¦ï¼šå‰ç«¯ç›´æ¥å‘¼å« CWA
// å‰ç«¯ â†’ CWA fileapi (æš´éœ² API Keyï¼)

// âœ… æ‡‰è©²ï¼šå¾Œç«¯è½‰ç™¼ + å¿«å–
// å‰ç«¯ â†’ ä½ çš„å¾Œç«¯ /api/wave â†’ CWA fileapi (å¾Œç«¯å¿«å–)

app.get('/api/wave/:locationCode', async (req, res) => {
  // ä½¿ç”¨å¿«å–é¡åˆ¥
  const forecast = await waveForecastCache.fetch();
  
  // åªå›å‚³è©²åœ°é»çš„è³‡æ–™
  const locationData = forecast.cwaopendata.dataset.location
    .filter(loc => loc.LocationCode === req.params.locationCode);
  
  res.json({
    success: true,
    data: locationData,
    meta: {
      issueTime: forecast.cwaopendata.dataset.datasetInfo.IssueTime,
      cached: waveForecastCache.isCacheFresh()
    }
  });
});
```

### 2. å¿«å–æŒä¹…åŒ–
```javascript
// å­˜åˆ°æª”æ¡ˆï¼ˆé‡å•Ÿå¾Œå¯æ¢å¾©ï¼‰
saveToDisk() {
  fs.writeFileSync('wave_cache.json', JSON.stringify({
    etag: this.etag,
    data: this.data,
    timestamp: this.lastFetchTime
  }));
}

// å•Ÿå‹•æ™‚è¼‰å…¥
loadFromDisk() {
  if (fs.existsSync('wave_cache.json')) {
    const cache = JSON.parse(fs.readFileSync('wave_cache.json'));
    // å¦‚æœå¿«å–ä¸è¶…é 12 å°æ™‚ï¼Œå°±ç”¨å®ƒ
    if (Date.now() - cache.timestamp < 12 * 3600 * 1000) {
      this.etag = cache.etag;
      this.data = cache.data;
      this.lastFetchTime = cache.timestamp;
    }
  }
}
```

---

## ğŸ“‹ ç¸½çµå°æ¯”è¡¨

| é …ç›® | M-B0078-001 | O-B0075-001 |
|------|-------------|-------------|
| è³‡æ–™é¡å‹ | 72å°æ™‚é å ± | å³æ™‚è§€æ¸¬ |
| æ›´æ–°é »ç‡ | æ¯ 6 å°æ™‚ | æ¯å°æ™‚ |
| å–®æ¬¡å¤§å° | 1-5 MBï¼ˆå…¨éƒ¨ï¼‰ | å¹¾ KBï¼ˆå–®ç«™ï¼‰|
| ETag æ”¯æ´ | âœ… å¿…é ˆä½¿ç”¨ | âŒ ç„¡ |
| å»ºè­°å¿«å– | 3-6 å°æ™‚ | 10-30 åˆ†é˜ |
| æŸ¥è©¢æ–¹å¼ | ä¸€æ¬¡å…¨æ‹¿ | å¯éæ¿¾æ¸¬ç«™ |
| é©ç”¨å ´æ™¯ | ç¨å¾Œé å ±åŠŸèƒ½ | å³æ™‚ç¾æ³ |

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **æ•´åˆåˆ°ç¾æœ‰ç³»çµ±**ï¼šå»ºç«‹ `/api/wave/:locationCode` ç«¯é»
2. **å¿«å–ç®¡ç†**ï¼šå¯¦ä½œ ETag + è¨˜æ†¶é«” + ç¡¬ç¢Ÿä¸‰å±¤å¿«å–
3. **å‰ç«¯å±•ç¤º**ï¼šæ·»åŠ ã€Œæœªä¾†é å ±ã€å€å¡Šé¡¯ç¤º 3/6/12/24 å°æ™‚é å ±
4. **ç›£æ§**ï¼šè¨˜éŒ„å¿«å–å‘½ä¸­ç‡å’Œ API å‘¼å«æ¬¡æ•¸

æœ‰éœ€è¦æˆ‘å¹«æ‚¨å¯¦ä½œæ•´åˆåˆ°ç¾æœ‰ server.js å—ï¼Ÿ
